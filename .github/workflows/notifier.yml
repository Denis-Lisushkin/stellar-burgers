name: PR Telegram Notifier

on:
  pull_request:
    types: [opened, closed]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram Notification
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_HEAD: ${{ github.event.pull_request.head.ref }}
          GITHUB_BASE: ${{ github.event.pull_request.base.ref }}
          GITHUB_TITLE: ${{ github.event.pull_request.title }}
          GITHUB_URL: ${{ github.event.pull_request.html_url }}
          MERGED: ${{ github.event.pull_request.merged }}
          ACTION: ${{ github.event.action }}
        run: |
          # –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏–º–≤–æ–ª–æ–≤ MarkdownV2
          escape_md2() {
            echo "$1" | sed -E 's/([_\*\[\]\(\)~`>#+\-=|{}.!])/\\\1/g'
          }

          HEAD=$(escape_md2 "$GITHUB_HEAD")
          BASE=$(escape_md2 "$GITHUB_BASE")
          TITLE=$(escape_md2 "$GITHUB_TITLE")
          ACTOR=$(escape_md2 "$GITHUB_ACTOR")
          URL=$(escape_md2 "$GITHUB_URL")

          if [[ "$ACTION" == "opened" ]]; then
            MESSAGE="üì¢ *–ù–æ–≤—ã–π Pull Request!*\n\nüë§ –ê–≤—Ç–æ—Ä: $ACTOR\nüîÄ –ò–∑ –≤–µ—Ç–∫–∏: *$HEAD*\n‚û°Ô∏è –í –≤–µ—Ç–∫—É: *$BASE*\nüìù –ó–∞–≥–æ–ª–æ–≤–æ–∫: *$TITLE*\nüîó $URL"
          elif [[ "$ACTION" == "closed" && "$MERGED" == "true" ]]; then
            MESSAGE="‚úÖ *Pull Request —Å–º–µ—Ä–∂–µ–Ω!*\n\nüë§ –ê–≤—Ç–æ—Ä: $ACTOR\nüîÄ –ò–∑ –≤–µ—Ç–∫–∏: *$HEAD*\n‚û°Ô∏è –í –≤–µ—Ç–∫—É: *$BASE*\nüìù –ó–∞–≥–æ–ª–æ–≤–æ–∫: *$TITLE*\nüîó $URL"

            if [[ "$BASE" == "main" ]]; then
              MESSAGE="$MESSAGE\n\n‚ö†Ô∏è *–í–ê–ñ–ù–û! –ù–µ –∑–∞–±—É–¥—å—Ç–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å:*\n\`git pull origin main\`"
            fi
          else
            exit 0
          fi

          curl -s -X POST https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage \
            -d chat_id=${TELEGRAM_CHAT_ID} \
            -d parse_mode="MarkdownV2" \
            -d text="$MESSAGE"
