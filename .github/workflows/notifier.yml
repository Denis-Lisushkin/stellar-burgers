name: PR Telegram Notifier

on:
  pull_request:
    types: [opened, closed]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram Notification
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è MarkdownV2 —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤, –∫—Ä–æ–º–µ –ø–µ—Ä–µ–Ω–æ—Å–∞ —Å—Ç—Ä–æ–∫–∏
          escape_md2() {
            echo "$1" | sed -E 's/([_\*\[\]\(\)~`>#+\-=|{}.!])/\\\1/g'
          }

          # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ PR
          HEAD=$(escape_md2 "${{ github.event.pull_request.head.ref }}")
          BASE=$(escape_md2 "${{ github.event.pull_request.base.ref }}")
          TITLE=$(escape_md2 "${{ github.event.pull_request.title }}")
          ACTOR=$(escape_md2 "${{ github.actor }}")
          URL=$(escape_md2 "${{ github.event.pull_request.html_url }}")
          ACTION="${{ github.event.action }}"
          MERGED="${{ github.event.pull_request.merged }}"

          # –ú–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è
          MESSAGE_LINES=()

          if [ "$ACTION" = "opened" ]; then
            MESSAGE_LINES+=("üì¢ *–ù–æ–≤—ã–π Pull Request!*")
            MESSAGE_LINES+=("üë§ –ê–≤—Ç–æ—Ä: $ACTOR")
            MESSAGE_LINES+=("üîÄ –ò–∑ –≤–µ—Ç–∫–∏: $HEAD")
            MESSAGE_LINES+=("‚û°Ô∏è –í –≤–µ—Ç–∫—É: $BASE")
            MESSAGE_LINES+=("üìù –ó–∞–≥–æ–ª–æ–≤–æ–∫: $TITLE")
            MESSAGE_LINES+=("üîó $URL")

          elif [ "$ACTION" = "closed" ] && [ "$MERGED" = "true" ]; then
            MESSAGE_LINES+=("‚úÖ *Pull Request —Å–º–µ—Ä–∂–µ–Ω!*")
            MESSAGE_LINES+=("üë§ –ê–≤—Ç–æ—Ä: $ACTOR")
            MESSAGE_LINES+=("üîÄ –ò–∑ –≤–µ—Ç–∫–∏: $HEAD")
            MESSAGE_LINES+=("‚û°Ô∏è –í –≤–µ—Ç–∫—É: $BASE")
            MESSAGE_LINES+=("üìù –ó–∞–≥–æ–ª–æ–≤–æ–∫: $TITLE")
            MESSAGE_LINES+=("üîó $URL")

            # –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø—Ä–æ git pull –¥–ª—è –≤–µ—Ç–∫–∏ dev
            if [ "$BASE" = "dev" ]; then
              MESSAGE_LINES+=("")
              MESSAGE_LINES+=("‚ö†Ô∏è *–í–ê–ñ–ù–û! –ù–µ –∑–∞–±—É–¥—å—Ç–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å:*")
              MESSAGE_LINES+=("\`git pull origin dev\`")
            fi
          else
            exit 0
          fi

          # –û–±—ä–µ–¥–∏–Ω—è–µ–º –º–∞—Å—Å–∏–≤ –≤ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—É—é —Å—Ç—Ä–æ–∫—É
          MESSAGE=$(printf "%s\n" "${MESSAGE_LINES[@]}")

          # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã MarkdownV2, –∫—Ä–æ–º–µ –ø–µ—Ä–µ–Ω–æ—Å–æ–≤
          MESSAGE_ESCAPED=$(echo "$MESSAGE" | sed -E 's/([_\*$begin:math:display$$end:math:display$$begin:math:text$$end:math:text$~`>#+\-=|{}.!])/\\\1/g')

          # –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode="MarkdownV2" \
            -d text="$MESSAGE_ESCAPED"
